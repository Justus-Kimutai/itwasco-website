---
import { getPublishedPosts } from "../../lib/supabase";

const posts = await getPublishedPosts();
const latestPost = posts.length > 0 ? posts[0] : null;
---

{latestPost && (
  <div id="blog-teaser" class="fixed bottom-6 right-6 z-50 hidden max-w-sm translate-x-full opacity-0 transition-all duration-500 ease-out sm:max-w-md">
    <div class="relative overflow-hidden rounded-xl bg-white shadow-2xl ring-1 ring-gray-100">
      <!-- Close button -->
      <button
        id="blog-teaser-close"
        class="absolute right-2 top-2 z-10 rounded-full bg-gray-100 p-1 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-600"
        aria-label="Dismiss"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <a href={`/blog/${latestPost.slug}`} class="block p-4 pr-10">
        <div class="flex items-start gap-3">
          {latestPost.image_url ? (
            <img
              src={latestPost.image_url}
              alt={latestPost.title}
              class="h-14 w-14 flex-shrink-0 rounded-lg object-cover"
            />
          ) : (
            <div class="flex-shrink-0 rounded-lg bg-primary-50 p-2">
              <svg class="h-6 w-6 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
              </svg>
            </div>
          )}

          <div class="min-w-0 flex-1">
            <!-- Badge -->
            <span class="blog-teaser-badge mb-1 inline-flex items-center gap-1 rounded-full bg-primary-100 px-2 py-0.5 text-xs font-semibold text-primary-700">
              <span class="blog-teaser-dot h-1.5 w-1.5 rounded-full bg-primary-500"></span>
              New Post
            </span>

            <!-- Title -->
            <h3 class="mt-1 truncate text-sm font-semibold text-gray-900">
              {latestPost.title}
            </h3>

            <!-- Excerpt -->
            <p class="mt-0.5 line-clamp-2 text-xs text-gray-500">
              {latestPost.excerpt}
            </p>

            <!-- Read more -->
            <span class="mt-2 inline-flex items-center gap-1 text-xs font-semibold text-primary-600">
              Read more
              <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </span>
          </div>
        </div>
      </a>
    </div>
  </div>
)}

<style>
  .blog-teaser-dot {
    animation: pulse-dot 2s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% {
      opacity: 1;
      box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4);
    }
    50% {
      opacity: 0.7;
      box-shadow: 0 0 0 4px rgba(14, 165, 233, 0);
    }
  }

  /* Mobile: full-width bottom bar */
  @media (max-width: 639px) {
    #blog-teaser {
      left: 1rem;
      right: 1rem;
      bottom: 1rem;
      max-width: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const teaser = document.getElementById('blog-teaser');
    const closeBtn = document.getElementById('blog-teaser-close');

    if (!teaser) return;

    // Don't show if dismissed this session
    if (sessionStorage.getItem('blog-teaser-dismissed')) return;

    // Show after 2s delay with slide-in
    setTimeout(() => {
      teaser.classList.remove('hidden');
      // Trigger reflow before removing transform
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          teaser.classList.remove('translate-x-full', 'opacity-0');
        });
      });
    }, 2000);

    // Dismiss
    closeBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      teaser.classList.add('translate-x-full', 'opacity-0');
      sessionStorage.setItem('blog-teaser-dismissed', 'true');
      setTimeout(() => teaser.classList.add('hidden'), 500);
    });
  });
</script>
